{"version":3,"sources":["../../../../../public/js/plugins/imagetools/plugin.js"],"names":["domGlobals","Cell","initial","value","get","set","v","clone","global","tinymce","util","Tools","resolve","global$1","noop","constant","never","always","none","NONE","eq","o","isNone","call","thunk","id","n","me","fold","s","is","isSome","getOr","getOrThunk","getOrDie","msg","Error","getOrNull","getOrUndefined","undefined","or","orThunk","map","each","bind","exists","forall","filter","equals","equals_","toArray","toString","Object","freeze","some","a","constant_a","self","f","elementEq","b","from","Option","create","width","height","resize","document","createElement","canvas","tCanvas","ctx","get2dContext","drawImage","getContext","getWidth","image","naturalWidth","getHeight","naturalHeight","promise","Promise","fn","TypeError","_state","_value","_deferreds","doResolve","reject","asap","immediateFn","window","setImmediate","setTimeout","thisArg","apply","arguments","isArray","Array","prototype","handle","deferred","push","cb","onFulfilled","onRejected","ret","e","newValue","then","finale","_i","_a","length","Handler","done","reason","ex","catch","all","values","args","slice","remaining","res","i","val","constructor","race","values_1","imageToBlob","src","indexOf","dataUriToBlob","anyUriToBlob","blobToImage","blob","blobUrl","URL","createObjectURL","Image","removeListeners","removeEventListener","loaded","error","type","addEventListener","complete","url","xhr","XMLHttpRequest","open","responseType","onload","status","response","onerror","_this","corsError","obj","code","name","genericError","send","dataUriToBlobSync","uri","data","split","matches","exec","mimetype","base64","sliceSize","byteCharacters","atob","bytesLength","slicesCount","Math","ceil","byteArrays","sliceIndex","begin","end","min","bytes","offset","charCodeAt","Uint8Array","Blob","canvasToBlob","quality","HTMLCanvasElement","toBlob","toDataURL","canvasToDataURL","blobToCanvas","revokeImageUrl","context","blobToDataUri","reader","FileReader","onloadend","result","readAsDataURL","revokeObjectURL","blobToImage$1","imageToBlob$1","create$1","getCanvas","initialType","getType","toBase64","toAdjustedBlob","toAdjustedDataURL","toAdjustedBase64","dataurl","toCanvas","fromBlob","fromCanvas","rotate","ir","angle","applyRotate","translateX","translateY","translate","PI","flip","axis","applyFlip","scale","flip$1","rotate$1","blobToImageResult","global$2","global$3","global$4","getToolbarItems","editor","getParam","getProxyUrl","getCorsHosts","getCredentialsHosts","getFetchImage","getApiKey","getUploadTimeout","shouldReuseFilename","getImageSize","img","isPxValue","test","style","w","parseInt","h","setImageSize","size","removeAttribute","setAttribute","getNaturalImageSize","ImageSize","typeOf","x","t","isPrototypeOf","String","isType","isFunction","nativeSlice","find","xs","pred","len","from$1","isValue","traverse","json","path","reduce","key","requestUrlAsBlob","headers","withCredentials","onreadystatechange","readyState","setRequestHeader","readBlob","fr","target","readAsText","parseJson","text","JSON","parse","Utils","friendlyHttpErrors","message","friendlyServiceErrors","isServiceErrorCode","getHttpErrorMsg","handleHttpError","getServiceErrorMsg","getServiceError","serviceError","errorType","errorMsg","handleServiceError","handleServiceErrorResponse","Errors","appendApiKey","apiKey","separator","encodeURIComponent","requestServiceBlob","requestBlob","getUrl","compareDocumentPosition","match","documentPositionPreceding","Node","DOCUMENT_POSITION_PRECEDING","documentPositionContainedBy","DOCUMENT_POSITION_CONTAINED_BY","firstMatch","regexes","find$1","agent","r","major","minor","group","Number","replace","nu","detect","versionRegexes","cleanedAgent","toLowerCase","unknown","Version","edge","chrome","ie","opera","firefox","safari","isBrowser","current","unknown$1","nu$1","version","info","isEdge","isChrome","isIE","isOpera","isFirefox","isSafari","Browser","windows","ios","android","linux","osx","solaris","freebsd","isOS","unknown$2","nu$2","isWindows","isiOS","isAndroid","isOSX","isLinux","isSolaris","isFreeBSD","OperatingSystem","DeviceType","os","browser","userAgent","mediaMatch","isiPad","isiPhone","isMobile","isTouch","isTablet","isPhone","iOSwebview","isDesktop","isWebView","detect$1","candidates","candidate","search","detectBrowser","browsers","detectOs","oses","UaString","contains","str","substr","normalVersionRegex","checkContains","uastring","PlatformInfo","detect$2","deviceType","PlatformDetection","query","matchMedia","platform","navigator","detect$3","fromHtml","html","scope","doc","div","innerHTML","hasChildNodes","childNodes","console","fromDom","fromTag","tag","node","fromText","createTextNode","dom","fromPoint","docElm","y","elementFromPoint","Element","ATTRIBUTE","ATTRIBUTE_NODE","CDATA_SECTION","CDATA_SECTION_NODE","COMMENT","COMMENT_NODE","DOCUMENT","DOCUMENT_NODE","DOCUMENT_TYPE","DOCUMENT_TYPE_NODE","DOCUMENT_FRAGMENT","DOCUMENT_FRAGMENT_NODE","ELEMENT","ELEMENT_NODE","TEXT","TEXT_NODE","PROCESSING_INSTRUCTION","PROCESSING_INSTRUCTION_NODE","ENTITY_REFERENCE","ENTITY_REFERENCE_NODE","ENTITY","ENTITY_NODE","NOTATION","NOTATION_NODE","ELEMENT$1","element","selector","nodeType","elem","msMatchesSelector","webkitMatchesSelector","mozMatchesSelector","regularContains","e1","e2","d1","d2","ieContains","contains$1","Global","Function","child","predicate","child$1","count","getFigureImg","isFigure","getEditableImage","isImage","imgNode","isEditable","isLocalImage","isCorsImage","settings","imagetools_proxy","imgOpt","displayError","notificationManager","getSelectedImage","selection","getNode","extractFilename","m","encode","createId","host","documentBaseURI","inArray","isCorsWithCredentialsImage","defaultFetchImage","imageToBlob$2","customFetchImage","findBlob","blobInfo","editorUpload","blobCache","getByUri","startTimedUpload","imageUploadTimerState","imageUploadTimer","setEditorTimeout","uploadImagesAuto","cancelTimedUpload","clearTimeout","updateSelectedImage","uploadImmediately","selectedImage","add","undoManager","transact","imageLoadedHandler","$","off","nodeChanged","on","attr","blobUri","removeAttr","selectedImageOperation","_scanForImages","imageResult","rotate$2","flippedSize","flip$2","handleDialogBlob","originalSize","newImage","newSize","Actions","saveState","disable","enable","createState","makeOpen","getLoadedSpec","currentState","title","body","items","label","buttons","primary","disabled","onSubmit","api","getData","imagetools","originalImgOpt","originalImg","originalSizeOpt","close","onCancel","onAction","details","origImg","_","state","windowManager","Dialog","register","mceImageRotateLeft","mceImageRotateRight","mceImageFlipVertical","mceImageFlipHorizontal","mceEditImage","cmd","addCommand","Commands","setup","lastSelectedImageState","lastSelectedImage","UploadSelectedImage","register$1","command","execCommand","ui","registry","addButton","tooltip","icon","onSetup","buttonApi","setDisabled","elementOpt","addContextMenu","update","Buttons","register$2","addContextToolbar","position","ContextToolbar","Plugin"],"mappings":"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","file":"plugin.js","sourcesContent":["/**\n * Copyright (c) Tiny Technologies, Inc. All rights reserved.\n * Licensed under the LGPL or a commercial license.\n * For LGPL see License.txt in the project root for license information.\n * For commercial licenses see https://www.tiny.cloud/\n *\n * Version: 5.1.0 (2019-10-17)\n */\n(function (domGlobals) {\n    'use strict';\n\n    var Cell = function (initial) {\n      var value = initial;\n      var get = function () {\n        return value;\n      };\n      var set = function (v) {\n        value = v;\n      };\n      var clone = function () {\n        return Cell(get());\n      };\n      return {\n        get: get,\n        set: set,\n        clone: clone\n      };\n    };\n\n    var global = tinymce.util.Tools.resolve('tinymce.PluginManager');\n\n    var global$1 = tinymce.util.Tools.resolve('tinymce.util.Tools');\n\n    var noop = function () {\n    };\n    var constant = function (value) {\n      return function () {\n        return value;\n      };\n    };\n    var never = constant(false);\n    var always = constant(true);\n\n    var none = function () {\n      return NONE;\n    };\n    var NONE = function () {\n      var eq = function (o) {\n        return o.isNone();\n      };\n      var call = function (thunk) {\n        return thunk();\n      };\n      var id = function (n) {\n        return n;\n      };\n      var me = {\n        fold: function (n, s) {\n          return n();\n        },\n        is: never,\n        isSome: never,\n        isNone: always,\n        getOr: id,\n        getOrThunk: call,\n        getOrDie: function (msg) {\n          throw new Error(msg || 'error: getOrDie called on none.');\n        },\n        getOrNull: constant(null),\n        getOrUndefined: constant(undefined),\n        or: id,\n        orThunk: call,\n        map: none,\n        each: noop,\n        bind: none,\n        exists: never,\n        forall: always,\n        filter: none,\n        equals: eq,\n        equals_: eq,\n        toArray: function () {\n          return [];\n        },\n        toString: constant('none()')\n      };\n      if (Object.freeze) {\n        Object.freeze(me);\n      }\n      return me;\n    }();\n    var some = function (a) {\n      var constant_a = constant(a);\n      var self = function () {\n        return me;\n      };\n      var bind = function (f) {\n        return f(a);\n      };\n      var me = {\n        fold: function (n, s) {\n          return s(a);\n        },\n        is: function (v) {\n          return a === v;\n        },\n        isSome: always,\n        isNone: never,\n        getOr: constant_a,\n        getOrThunk: constant_a,\n        getOrDie: constant_a,\n        getOrNull: constant_a,\n        getOrUndefined: constant_a,\n        or: self,\n        orThunk: self,\n        map: function (f) {\n          return some(f(a));\n        },\n        each: function (f) {\n          f(a);\n        },\n        bind: bind,\n        exists: bind,\n        forall: bind,\n        filter: function (f) {\n          return f(a) ? me : NONE;\n        },\n        toArray: function () {\n          return [a];\n        },\n        toString: function () {\n          return 'some(' + a + ')';\n        },\n        equals: function (o) {\n          return o.is(a);\n        },\n        equals_: function (o, elementEq) {\n          return o.fold(never, function (b) {\n            return elementEq(a, b);\n          });\n        }\n      };\n      return me;\n    };\n    var from = function (value) {\n      return value === null || value === undefined ? NONE : some(value);\n    };\n    var Option = {\n      some: some,\n      none: none,\n      from: from\n    };\n\n    function create(width, height) {\n      return resize(domGlobals.document.createElement('canvas'), width, height);\n    }\n    function clone(canvas) {\n      var tCanvas = create(canvas.width, canvas.height);\n      var ctx = get2dContext(tCanvas);\n      ctx.drawImage(canvas, 0, 0);\n      return tCanvas;\n    }\n    function get2dContext(canvas) {\n      return canvas.getContext('2d');\n    }\n    function resize(canvas, width, height) {\n      canvas.width = width;\n      canvas.height = height;\n      return canvas;\n    }\n\n    function getWidth(image) {\n      return image.naturalWidth || image.width;\n    }\n    function getHeight(image) {\n      return image.naturalHeight || image.height;\n    }\n\n    var promise = function () {\n      var Promise = function (fn) {\n        if (typeof this !== 'object') {\n          throw new TypeError('Promises must be constructed via new');\n        }\n        if (typeof fn !== 'function') {\n          throw new TypeError('not a function');\n        }\n        this._state = null;\n        this._value = null;\n        this._deferreds = [];\n        doResolve(fn, bind(resolve, this), bind(reject, this));\n      };\n      var asap = Promise.immediateFn || typeof window.setImmediate === 'function' && window.setImmediate || function (fn) {\n        domGlobals.setTimeout(fn, 1);\n      };\n      function bind(fn, thisArg) {\n        return function () {\n          return fn.apply(thisArg, arguments);\n        };\n      }\n      var isArray = Array.isArray || function (value) {\n        return Object.prototype.toString.call(value) === '[object Array]';\n      };\n      function handle(deferred) {\n        var me = this;\n        if (this._state === null) {\n          this._deferreds.push(deferred);\n          return;\n        }\n        asap(function () {\n          var cb = me._state ? deferred.onFulfilled : deferred.onRejected;\n          if (cb === null) {\n            (me._state ? deferred.resolve : deferred.reject)(me._value);\n            return;\n          }\n          var ret;\n          try {\n            ret = cb(me._value);\n          } catch (e) {\n            deferred.reject(e);\n            return;\n          }\n          deferred.resolve(ret);\n        });\n      }\n      function resolve(newValue) {\n        try {\n          if (newValue === this) {\n            throw new TypeError('A promise cannot be resolved with itself.');\n          }\n          if (newValue && (typeof newValue === 'object' || typeof newValue === 'function')) {\n            var then = newValue.then;\n            if (typeof then === 'function') {\n              doResolve(bind(then, newValue), bind(resolve, this), bind(reject, this));\n              return;\n            }\n          }\n          this._state = true;\n          this._value = newValue;\n          finale.call(this);\n        } catch (e) {\n          reject.call(this, e);\n        }\n      }\n      function reject(newValue) {\n        this._state = false;\n        this._value = newValue;\n        finale.call(this);\n      }\n      function finale() {\n        for (var _i = 0, _a = this._deferreds; _i < _a.length; _i++) {\n          var deferred = _a[_i];\n          handle.call(this, deferred);\n        }\n        this._deferreds = [];\n      }\n      function Handler(onFulfilled, onRejected, resolve, reject) {\n        this.onFulfilled = typeof onFulfilled === 'function' ? onFulfilled : null;\n        this.onRejected = typeof onRejected === 'function' ? onRejected : null;\n        this.resolve = resolve;\n        this.reject = reject;\n      }\n      function doResolve(fn, onFulfilled, onRejected) {\n        var done = false;\n        try {\n          fn(function (value) {\n            if (done) {\n              return;\n            }\n            done = true;\n            onFulfilled(value);\n          }, function (reason) {\n            if (done) {\n              return;\n            }\n            done = true;\n            onRejected(reason);\n          });\n        } catch (ex) {\n          if (done) {\n            return;\n          }\n          done = true;\n          onRejected(ex);\n        }\n      }\n      Promise.prototype.catch = function (onRejected) {\n        return this.then(null, onRejected);\n      };\n      Promise.prototype.then = function (onFulfilled, onRejected) {\n        var me = this;\n        return new Promise(function (resolve, reject) {\n          handle.call(me, new Handler(onFulfilled, onRejected, resolve, reject));\n        });\n      };\n      Promise.all = function () {\n        var values = [];\n        for (var _i = 0; _i < arguments.length; _i++) {\n          values[_i] = arguments[_i];\n        }\n        var args = Array.prototype.slice.call(values.length === 1 && isArray(values[0]) ? values[0] : values);\n        return new Promise(function (resolve, reject) {\n          if (args.length === 0) {\n            return resolve([]);\n          }\n          var remaining = args.length;\n          function res(i, val) {\n            try {\n              if (val && (typeof val === 'object' || typeof val === 'function')) {\n                var then = val.then;\n                if (typeof then === 'function') {\n                  then.call(val, function (val) {\n                    res(i, val);\n                  }, reject);\n                  return;\n                }\n              }\n              args[i] = val;\n              if (--remaining === 0) {\n                resolve(args);\n              }\n            } catch (ex) {\n              reject(ex);\n            }\n          }\n          for (var i = 0; i < args.length; i++) {\n            res(i, args[i]);\n          }\n        });\n      };\n      Promise.resolve = function (value) {\n        if (value && typeof value === 'object' && value.constructor === Promise) {\n          return value;\n        }\n        return new Promise(function (resolve) {\n          resolve(value);\n        });\n      };\n      Promise.reject = function (reason) {\n        return new Promise(function (resolve, reject) {\n          reject(reason);\n        });\n      };\n      Promise.race = function (values) {\n        return new Promise(function (resolve, reject) {\n          for (var _i = 0, values_1 = values; _i < values_1.length; _i++) {\n            var value = values_1[_i];\n            value.then(resolve, reject);\n          }\n        });\n      };\n      return Promise;\n    };\n    var Promise = window.Promise ? window.Promise : promise();\n\n    function imageToBlob(image) {\n      var src = image.src;\n      if (src.indexOf('data:') === 0) {\n        return dataUriToBlob(src);\n      }\n      return anyUriToBlob(src);\n    }\n    function blobToImage(blob) {\n      return new Promise(function (resolve, reject) {\n        var blobUrl = domGlobals.URL.createObjectURL(blob);\n        var image = new domGlobals.Image();\n        var removeListeners = function () {\n          image.removeEventListener('load', loaded);\n          image.removeEventListener('error', error);\n        };\n        function loaded() {\n          removeListeners();\n          resolve(image);\n        }\n        function error() {\n          removeListeners();\n          reject('Unable to load data of type ' + blob.type + ': ' + blobUrl);\n        }\n        image.addEventListener('load', loaded);\n        image.addEventListener('error', error);\n        image.src = blobUrl;\n        if (image.complete) {\n          loaded();\n        }\n      });\n    }\n    function anyUriToBlob(url) {\n      return new Promise(function (resolve, reject) {\n        var xhr = new domGlobals.XMLHttpRequest();\n        xhr.open('GET', url, true);\n        xhr.responseType = 'blob';\n        xhr.onload = function () {\n          if (this.status === 200) {\n            resolve(this.response);\n          }\n        };\n        xhr.onerror = function () {\n          var _this = this;\n          var corsError = function () {\n            var obj = new Error('No access to download image');\n            obj.code = 18;\n            obj.name = 'SecurityError';\n            return obj;\n          };\n          var genericError = function () {\n            return new Error('Error ' + _this.status + ' downloading image');\n          };\n          reject(this.status === 0 ? corsError() : genericError());\n        };\n        xhr.send();\n      });\n    }\n    function dataUriToBlobSync(uri) {\n      var data = uri.split(',');\n      var matches = /data:([^;]+)/.exec(data[0]);\n      if (!matches) {\n        return Option.none();\n      }\n      var mimetype = matches[1];\n      var base64 = data[1];\n      var sliceSize = 1024;\n      var byteCharacters = domGlobals.atob(base64);\n      var bytesLength = byteCharacters.length;\n      var slicesCount = Math.ceil(bytesLength / sliceSize);\n      var byteArrays = new Array(slicesCount);\n      for (var sliceIndex = 0; sliceIndex < slicesCount; ++sliceIndex) {\n        var begin = sliceIndex * sliceSize;\n        var end = Math.min(begin + sliceSize, bytesLength);\n        var bytes = new Array(end - begin);\n        for (var offset = begin, i = 0; offset < end; ++i, ++offset) {\n          bytes[i] = byteCharacters[offset].charCodeAt(0);\n        }\n        byteArrays[sliceIndex] = new Uint8Array(bytes);\n      }\n      return Option.some(new domGlobals.Blob(byteArrays, { type: mimetype }));\n    }\n    function dataUriToBlob(uri) {\n      return new Promise(function (resolve, reject) {\n        dataUriToBlobSync(uri).fold(function () {\n          reject('uri is not base64: ' + uri);\n        }, resolve);\n      });\n    }\n    function canvasToBlob(canvas, type, quality) {\n      type = type || 'image/png';\n      if (domGlobals.HTMLCanvasElement.prototype.toBlob) {\n        return new Promise(function (resolve, reject) {\n          canvas.toBlob(function (blob) {\n            if (blob) {\n              resolve(blob);\n            } else {\n              reject();\n            }\n          }, type, quality);\n        });\n      } else {\n        return dataUriToBlob(canvas.toDataURL(type, quality));\n      }\n    }\n    function canvasToDataURL(canvas, type, quality) {\n      type = type || 'image/png';\n      return canvas.toDataURL(type, quality);\n    }\n    function blobToCanvas(blob) {\n      return blobToImage(blob).then(function (image) {\n        revokeImageUrl(image);\n        var canvas = create(getWidth(image), getHeight(image));\n        var context = get2dContext(canvas);\n        context.drawImage(image, 0, 0);\n        return canvas;\n      });\n    }\n    function blobToDataUri(blob) {\n      return new Promise(function (resolve) {\n        var reader = new domGlobals.FileReader();\n        reader.onloadend = function () {\n          resolve(reader.result);\n        };\n        reader.readAsDataURL(blob);\n      });\n    }\n    function revokeImageUrl(image) {\n      domGlobals.URL.revokeObjectURL(image.src);\n    }\n\n    var blobToImage$1 = function (blob) {\n      return blobToImage(blob);\n    };\n    var imageToBlob$1 = function (image) {\n      return imageToBlob(image);\n    };\n\n    function create$1(getCanvas, blob, uri) {\n      var initialType = blob.type;\n      var getType = constant(initialType);\n      function toBlob() {\n        return Promise.resolve(blob);\n      }\n      function toDataURL() {\n        return uri;\n      }\n      function toBase64() {\n        return uri.split(',')[1];\n      }\n      function toAdjustedBlob(type, quality) {\n        return getCanvas.then(function (canvas) {\n          return canvasToBlob(canvas, type, quality);\n        });\n      }\n      function toAdjustedDataURL(type, quality) {\n        return getCanvas.then(function (canvas) {\n          return canvasToDataURL(canvas, type, quality);\n        });\n      }\n      function toAdjustedBase64(type, quality) {\n        return toAdjustedDataURL(type, quality).then(function (dataurl) {\n          return dataurl.split(',')[1];\n        });\n      }\n      function toCanvas() {\n        return getCanvas.then(clone);\n      }\n      return {\n        getType: getType,\n        toBlob: toBlob,\n        toDataURL: toDataURL,\n        toBase64: toBase64,\n        toAdjustedBlob: toAdjustedBlob,\n        toAdjustedDataURL: toAdjustedDataURL,\n        toAdjustedBase64: toAdjustedBase64,\n        toCanvas: toCanvas\n      };\n    }\n    function fromBlob(blob) {\n      return blobToDataUri(blob).then(function (uri) {\n        return create$1(blobToCanvas(blob), blob, uri);\n      });\n    }\n    function fromCanvas(canvas, type) {\n      return canvasToBlob(canvas, type).then(function (blob) {\n        return create$1(Promise.resolve(canvas), blob, canvas.toDataURL());\n      });\n    }\n\n    function rotate(ir, angle) {\n      return ir.toCanvas().then(function (canvas) {\n        return applyRotate(canvas, ir.getType(), angle);\n      });\n    }\n    function applyRotate(image, type, angle) {\n      var canvas = create(image.width, image.height);\n      var context = get2dContext(canvas);\n      var translateX = 0;\n      var translateY = 0;\n      angle = angle < 0 ? 360 + angle : angle;\n      if (angle === 90 || angle === 270) {\n        resize(canvas, canvas.height, canvas.width);\n      }\n      if (angle === 90 || angle === 180) {\n        translateX = canvas.width;\n      }\n      if (angle === 270 || angle === 180) {\n        translateY = canvas.height;\n      }\n      context.translate(translateX, translateY);\n      context.rotate(angle * Math.PI / 180);\n      context.drawImage(image, 0, 0);\n      return fromCanvas(canvas, type);\n    }\n    function flip(ir, axis) {\n      return ir.toCanvas().then(function (canvas) {\n        return applyFlip(canvas, ir.getType(), axis);\n      });\n    }\n    function applyFlip(image, type, axis) {\n      var canvas = create(image.width, image.height);\n      var context = get2dContext(canvas);\n      if (axis === 'v') {\n        context.scale(1, -1);\n        context.drawImage(image, 0, -canvas.height);\n      } else {\n        context.scale(-1, 1);\n        context.drawImage(image, -canvas.width, 0);\n      }\n      return fromCanvas(canvas, type);\n    }\n\n    var flip$1 = function (ir, axis) {\n      return flip(ir, axis);\n    };\n    var rotate$1 = function (ir, angle) {\n      return rotate(ir, angle);\n    };\n\n    var blobToImageResult = function (blob) {\n      return fromBlob(blob);\n    };\n\n    var global$2 = tinymce.util.Tools.resolve('tinymce.util.Delay');\n\n    var global$3 = tinymce.util.Tools.resolve('tinymce.util.Promise');\n\n    var global$4 = tinymce.util.Tools.resolve('tinymce.util.URI');\n\n    var getToolbarItems = function (editor) {\n      return editor.getParam('imagetools_toolbar', 'rotateleft rotateright flipv fliph editimage imageoptions');\n    };\n    var getProxyUrl = function (editor) {\n      return editor.getParam('imagetools_proxy');\n    };\n    var getCorsHosts = function (editor) {\n      return editor.getParam('imagetools_cors_hosts', [], 'string[]');\n    };\n    var getCredentialsHosts = function (editor) {\n      return editor.getParam('imagetools_credentials_hosts', [], 'string[]');\n    };\n    var getFetchImage = function (editor) {\n      return Option.from(editor.getParam('imagetools_fetch_image', null, 'function'));\n    };\n    var getApiKey = function (editor) {\n      return editor.getParam('api_key', editor.getParam('imagetools_api_key', '', 'string'), 'string');\n    };\n    var getUploadTimeout = function (editor) {\n      return editor.getParam('images_upload_timeout', 30000, 'number');\n    };\n    var shouldReuseFilename = function (editor) {\n      return editor.getParam('images_reuse_filename', false, 'boolean');\n    };\n\n    function getImageSize(img) {\n      var width, height;\n      function isPxValue(value) {\n        return /^[0-9\\.]+px$/.test(value);\n      }\n      width = img.style.width;\n      height = img.style.height;\n      if (width || height) {\n        if (isPxValue(width) && isPxValue(height)) {\n          return {\n            w: parseInt(width, 10),\n            h: parseInt(height, 10)\n          };\n        }\n        return null;\n      }\n      width = img.width;\n      height = img.height;\n      if (width && height) {\n        return {\n          w: parseInt(width, 10),\n          h: parseInt(height, 10)\n        };\n      }\n      return null;\n    }\n    function setImageSize(img, size) {\n      var width, height;\n      if (size) {\n        width = img.style.width;\n        height = img.style.height;\n        if (width || height) {\n          img.style.width = size.w + 'px';\n          img.style.height = size.h + 'px';\n          img.removeAttribute('data-mce-style');\n        }\n        width = img.width;\n        height = img.height;\n        if (width || height) {\n          img.setAttribute('width', size.w);\n          img.setAttribute('height', size.h);\n        }\n      }\n    }\n    function getNaturalImageSize(img) {\n      return {\n        w: img.naturalWidth,\n        h: img.naturalHeight\n      };\n    }\n    var ImageSize = {\n      getImageSize: getImageSize,\n      setImageSize: setImageSize,\n      getNaturalImageSize: getNaturalImageSize\n    };\n\n    var typeOf = function (x) {\n      if (x === null) {\n        return 'null';\n      }\n      var t = typeof x;\n      if (t === 'object' && (Array.prototype.isPrototypeOf(x) || x.constructor && x.constructor.name === 'Array')) {\n        return 'array';\n      }\n      if (t === 'object' && (String.prototype.isPrototypeOf(x) || x.constructor && x.constructor.name === 'String')) {\n        return 'string';\n      }\n      return t;\n    };\n    var isType = function (type) {\n      return function (value) {\n        return typeOf(value) === type;\n      };\n    };\n    var isFunction = isType('function');\n\n    var nativeSlice = Array.prototype.slice;\n    var find = function (xs, pred) {\n      for (var i = 0, len = xs.length; i < len; i++) {\n        var x = xs[i];\n        if (pred(x, i)) {\n          return Option.some(x);\n        }\n      }\n      return Option.none();\n    };\n    var from$1 = isFunction(Array.from) ? Array.from : function (x) {\n      return nativeSlice.call(x);\n    };\n\n    var isValue = function (obj) {\n      return obj !== null && obj !== undefined;\n    };\n    var traverse = function (json, path) {\n      var value;\n      value = path.reduce(function (result, key) {\n        return isValue(result) ? result[key] : undefined;\n      }, json);\n      return isValue(value) ? value : null;\n    };\n    var requestUrlAsBlob = function (url, headers, withCredentials) {\n      return new global$3(function (resolve) {\n        var xhr;\n        xhr = new domGlobals.XMLHttpRequest();\n        xhr.onreadystatechange = function () {\n          if (xhr.readyState === 4) {\n            resolve({\n              status: xhr.status,\n              blob: this.response\n            });\n          }\n        };\n        xhr.open('GET', url, true);\n        xhr.withCredentials = withCredentials;\n        global$1.each(headers, function (value, key) {\n          xhr.setRequestHeader(key, value);\n        });\n        xhr.responseType = 'blob';\n        xhr.send();\n      });\n    };\n    var readBlob = function (blob) {\n      return new global$3(function (resolve) {\n        var fr = new domGlobals.FileReader();\n        fr.onload = function (e) {\n          var data = e.target;\n          resolve(data.result);\n        };\n        fr.readAsText(blob);\n      });\n    };\n    var parseJson = function (text) {\n      var json;\n      try {\n        json = JSON.parse(text);\n      } catch (ex) {\n      }\n      return json;\n    };\n    var Utils = {\n      traverse: traverse,\n      readBlob: readBlob,\n      requestUrlAsBlob: requestUrlAsBlob,\n      parseJson: parseJson\n    };\n\n    var friendlyHttpErrors = [\n      {\n        code: 404,\n        message: 'Could not find Image Proxy'\n      },\n      {\n        code: 403,\n        message: 'Rejected request'\n      },\n      {\n        code: 0,\n        message: 'Incorrect Image Proxy URL'\n      }\n    ];\n    var friendlyServiceErrors = [\n      {\n        type: 'key_missing',\n        message: 'The request did not include an api key.'\n      },\n      {\n        type: 'key_not_found',\n        message: 'The provided api key could not be found.'\n      },\n      {\n        type: 'domain_not_trusted',\n        message: 'The api key is not valid for the request origins.'\n      }\n    ];\n    var isServiceErrorCode = function (code) {\n      return code === 400 || code === 403 || code === 500;\n    };\n    var getHttpErrorMsg = function (status) {\n      var message = find(friendlyHttpErrors, function (error) {\n        return status === error.code;\n      }).fold(constant('Unknown ImageProxy error'), function (error) {\n        return error.message;\n      });\n      return 'ImageProxy HTTP error: ' + message;\n    };\n    var handleHttpError = function (status) {\n      var message = getHttpErrorMsg(status);\n      return global$3.reject(message);\n    };\n    var getServiceErrorMsg = function (type) {\n      return find(friendlyServiceErrors, function (error) {\n        return error.type === type;\n      }).fold(constant('Unknown service error'), function (error) {\n        return error.message;\n      });\n    };\n    var getServiceError = function (text) {\n      var serviceError = Utils.parseJson(text);\n      var errorType = Utils.traverse(serviceError, [\n        'error',\n        'type'\n      ]);\n      var errorMsg = errorType ? getServiceErrorMsg(errorType) : 'Invalid JSON in service error message';\n      return 'ImageProxy Service error: ' + errorMsg;\n    };\n    var handleServiceError = function (status, blob) {\n      return Utils.readBlob(blob).then(function (text) {\n        var serviceError = getServiceError(text);\n        return global$3.reject(serviceError);\n      });\n    };\n    var handleServiceErrorResponse = function (status, blob) {\n      return isServiceErrorCode(status) ? handleServiceError(status, blob) : handleHttpError(status);\n    };\n    var Errors = {\n      handleServiceErrorResponse: handleServiceErrorResponse,\n      handleHttpError: handleHttpError,\n      getHttpErrorMsg: getHttpErrorMsg,\n      getServiceErrorMsg: getServiceErrorMsg\n    };\n\n    var appendApiKey = function (url, apiKey) {\n      var separator = url.indexOf('?') === -1 ? '?' : '&';\n      if (/[?&]apiKey=/.test(url) || !apiKey) {\n        return url;\n      } else {\n        return url + separator + 'apiKey=' + encodeURIComponent(apiKey);\n      }\n    };\n    var requestServiceBlob = function (url, apiKey) {\n      var headers = {\n        'Content-Type': 'application/json;charset=UTF-8',\n        'tiny-api-key': apiKey\n      };\n      return Utils.requestUrlAsBlob(appendApiKey(url, apiKey), headers, false).then(function (result) {\n        return result.status < 200 || result.status >= 300 ? Errors.handleServiceErrorResponse(result.status, result.blob) : global$3.resolve(result.blob);\n      });\n    };\n    function requestBlob(url, withCredentials) {\n      return Utils.requestUrlAsBlob(url, {}, withCredentials).then(function (result) {\n        return result.status < 200 || result.status >= 300 ? Errors.handleHttpError(result.status) : global$3.resolve(result.blob);\n      });\n    }\n    var getUrl = function (url, apiKey, withCredentials) {\n      return apiKey ? requestServiceBlob(url, apiKey) : requestBlob(url, withCredentials);\n    };\n\n    var compareDocumentPosition = function (a, b, match) {\n      return (a.compareDocumentPosition(b) & match) !== 0;\n    };\n    var documentPositionPreceding = function (a, b) {\n      return compareDocumentPosition(a, b, domGlobals.Node.DOCUMENT_POSITION_PRECEDING);\n    };\n    var documentPositionContainedBy = function (a, b) {\n      return compareDocumentPosition(a, b, domGlobals.Node.DOCUMENT_POSITION_CONTAINED_BY);\n    };\n    var Node = {\n      documentPositionPreceding: documentPositionPreceding,\n      documentPositionContainedBy: documentPositionContainedBy\n    };\n\n    var firstMatch = function (regexes, s) {\n      for (var i = 0; i < regexes.length; i++) {\n        var x = regexes[i];\n        if (x.test(s)) {\n          return x;\n        }\n      }\n      return undefined;\n    };\n    var find$1 = function (regexes, agent) {\n      var r = firstMatch(regexes, agent);\n      if (!r) {\n        return {\n          major: 0,\n          minor: 0\n        };\n      }\n      var group = function (i) {\n        return Number(agent.replace(r, '$' + i));\n      };\n      return nu(group(1), group(2));\n    };\n    var detect = function (versionRegexes, agent) {\n      var cleanedAgent = String(agent).toLowerCase();\n      if (versionRegexes.length === 0) {\n        return unknown();\n      }\n      return find$1(versionRegexes, cleanedAgent);\n    };\n    var unknown = function () {\n      return nu(0, 0);\n    };\n    var nu = function (major, minor) {\n      return {\n        major: major,\n        minor: minor\n      };\n    };\n    var Version = {\n      nu: nu,\n      detect: detect,\n      unknown: unknown\n    };\n\n    var edge = 'Edge';\n    var chrome = 'Chrome';\n    var ie = 'IE';\n    var opera = 'Opera';\n    var firefox = 'Firefox';\n    var safari = 'Safari';\n    var isBrowser = function (name, current) {\n      return function () {\n        return current === name;\n      };\n    };\n    var unknown$1 = function () {\n      return nu$1({\n        current: undefined,\n        version: Version.unknown()\n      });\n    };\n    var nu$1 = function (info) {\n      var current = info.current;\n      var version = info.version;\n      return {\n        current: current,\n        version: version,\n        isEdge: isBrowser(edge, current),\n        isChrome: isBrowser(chrome, current),\n        isIE: isBrowser(ie, current),\n        isOpera: isBrowser(opera, current),\n        isFirefox: isBrowser(firefox, current),\n        isSafari: isBrowser(safari, current)\n      };\n    };\n    var Browser = {\n      unknown: unknown$1,\n      nu: nu$1,\n      edge: constant(edge),\n      chrome: constant(chrome),\n      ie: constant(ie),\n      opera: constant(opera),\n      firefox: constant(firefox),\n      safari: constant(safari)\n    };\n\n    var windows = 'Windows';\n    var ios = 'iOS';\n    var android = 'Android';\n    var linux = 'Linux';\n    var osx = 'OSX';\n    var solaris = 'Solaris';\n    var freebsd = 'FreeBSD';\n    var isOS = function (name, current) {\n      return function () {\n        return current === name;\n      };\n    };\n    var unknown$2 = function () {\n      return nu$2({\n        current: undefined,\n        version: Version.unknown()\n      });\n    };\n    var nu$2 = function (info) {\n      var current = info.current;\n      var version = info.version;\n      return {\n        current: current,\n        version: version,\n        isWindows: isOS(windows, current),\n        isiOS: isOS(ios, current),\n        isAndroid: isOS(android, current),\n        isOSX: isOS(osx, current),\n        isLinux: isOS(linux, current),\n        isSolaris: isOS(solaris, current),\n        isFreeBSD: isOS(freebsd, current)\n      };\n    };\n    var OperatingSystem = {\n      unknown: unknown$2,\n      nu: nu$2,\n      windows: constant(windows),\n      ios: constant(ios),\n      android: constant(android),\n      linux: constant(linux),\n      osx: constant(osx),\n      solaris: constant(solaris),\n      freebsd: constant(freebsd)\n    };\n\n    var DeviceType = function (os, browser, userAgent, mediaMatch) {\n      var isiPad = os.isiOS() && /ipad/i.test(userAgent) === true;\n      var isiPhone = os.isiOS() && !isiPad;\n      var isMobile = os.isiOS() || os.isAndroid();\n      var isTouch = isMobile || mediaMatch('(pointer:coarse)');\n      var isTablet = isiPad || !isiPhone && isMobile && mediaMatch('(min-device-width:768px)');\n      var isPhone = isiPhone || isMobile && !isTablet;\n      var iOSwebview = browser.isSafari() && os.isiOS() && /safari/i.test(userAgent) === false;\n      var isDesktop = !isPhone && !isTablet && !iOSwebview;\n      return {\n        isiPad: constant(isiPad),\n        isiPhone: constant(isiPhone),\n        isTablet: constant(isTablet),\n        isPhone: constant(isPhone),\n        isTouch: constant(isTouch),\n        isAndroid: os.isAndroid,\n        isiOS: os.isiOS,\n        isWebView: constant(iOSwebview),\n        isDesktop: constant(isDesktop)\n      };\n    };\n\n    var detect$1 = function (candidates, userAgent) {\n      var agent = String(userAgent).toLowerCase();\n      return find(candidates, function (candidate) {\n        return candidate.search(agent);\n      });\n    };\n    var detectBrowser = function (browsers, userAgent) {\n      return detect$1(browsers, userAgent).map(function (browser) {\n        var version = Version.detect(browser.versionRegexes, userAgent);\n        return {\n          current: browser.name,\n          version: version\n        };\n      });\n    };\n    var detectOs = function (oses, userAgent) {\n      return detect$1(oses, userAgent).map(function (os) {\n        var version = Version.detect(os.versionRegexes, userAgent);\n        return {\n          current: os.name,\n          version: version\n        };\n      });\n    };\n    var UaString = {\n      detectBrowser: detectBrowser,\n      detectOs: detectOs\n    };\n\n    var contains = function (str, substr) {\n      return str.indexOf(substr) !== -1;\n    };\n\n    var normalVersionRegex = /.*?version\\/\\ ?([0-9]+)\\.([0-9]+).*/;\n    var checkContains = function (target) {\n      return function (uastring) {\n        return contains(uastring, target);\n      };\n    };\n    var browsers = [\n      {\n        name: 'Edge',\n        versionRegexes: [/.*?edge\\/ ?([0-9]+)\\.([0-9]+)$/],\n        search: function (uastring) {\n          return contains(uastring, 'edge/') && contains(uastring, 'chrome') && contains(uastring, 'safari') && contains(uastring, 'applewebkit');\n        }\n      },\n      {\n        name: 'Chrome',\n        versionRegexes: [\n          /.*?chrome\\/([0-9]+)\\.([0-9]+).*/,\n          normalVersionRegex\n        ],\n        search: function (uastring) {\n          return contains(uastring, 'chrome') && !contains(uastring, 'chromeframe');\n        }\n      },\n      {\n        name: 'IE',\n        versionRegexes: [\n          /.*?msie\\ ?([0-9]+)\\.([0-9]+).*/,\n          /.*?rv:([0-9]+)\\.([0-9]+).*/\n        ],\n        search: function (uastring) {\n          return contains(uastring, 'msie') || contains(uastring, 'trident');\n        }\n      },\n      {\n        name: 'Opera',\n        versionRegexes: [\n          normalVersionRegex,\n          /.*?opera\\/([0-9]+)\\.([0-9]+).*/\n        ],\n        search: checkContains('opera')\n      },\n      {\n        name: 'Firefox',\n        versionRegexes: [/.*?firefox\\/\\ ?([0-9]+)\\.([0-9]+).*/],\n        search: checkContains('firefox')\n      },\n      {\n        name: 'Safari',\n        versionRegexes: [\n          normalVersionRegex,\n          /.*?cpu os ([0-9]+)_([0-9]+).*/\n        ],\n        search: function (uastring) {\n          return (contains(uastring, 'safari') || contains(uastring, 'mobile/')) && contains(uastring, 'applewebkit');\n        }\n      }\n    ];\n    var oses = [\n      {\n        name: 'Windows',\n        search: checkContains('win'),\n        versionRegexes: [/.*?windows\\ nt\\ ?([0-9]+)\\.([0-9]+).*/]\n      },\n      {\n        name: 'iOS',\n        search: function (uastring) {\n          return contains(uastring, 'iphone') || contains(uastring, 'ipad');\n        },\n        versionRegexes: [\n          /.*?version\\/\\ ?([0-9]+)\\.([0-9]+).*/,\n          /.*cpu os ([0-9]+)_([0-9]+).*/,\n          /.*cpu iphone os ([0-9]+)_([0-9]+).*/\n        ]\n      },\n      {\n        name: 'Android',\n        search: checkContains('android'),\n        versionRegexes: [/.*?android\\ ?([0-9]+)\\.([0-9]+).*/]\n      },\n      {\n        name: 'OSX',\n        search: checkContains('os x'),\n        versionRegexes: [/.*?os\\ x\\ ?([0-9]+)_([0-9]+).*/]\n      },\n      {\n        name: 'Linux',\n        search: checkContains('linux'),\n        versionRegexes: []\n      },\n      {\n        name: 'Solaris',\n        search: checkContains('sunos'),\n        versionRegexes: []\n      },\n      {\n        name: 'FreeBSD',\n        search: checkContains('freebsd'),\n        versionRegexes: []\n      }\n    ];\n    var PlatformInfo = {\n      browsers: constant(browsers),\n      oses: constant(oses)\n    };\n\n    var detect$2 = function (userAgent, mediaMatch) {\n      var browsers = PlatformInfo.browsers();\n      var oses = PlatformInfo.oses();\n      var browser = UaString.detectBrowser(browsers, userAgent).fold(Browser.unknown, Browser.nu);\n      var os = UaString.detectOs(oses, userAgent).fold(OperatingSystem.unknown, OperatingSystem.nu);\n      var deviceType = DeviceType(os, browser, userAgent, mediaMatch);\n      return {\n        browser: browser,\n        os: os,\n        deviceType: deviceType\n      };\n    };\n    var PlatformDetection = { detect: detect$2 };\n\n    var mediaMatch = function (query) {\n      return domGlobals.window.matchMedia(query).matches;\n    };\n    var platform = Cell(PlatformDetection.detect(domGlobals.navigator.userAgent, mediaMatch));\n    var detect$3 = function () {\n      return platform.get();\n    };\n\n    var fromHtml = function (html, scope) {\n      var doc = scope || domGlobals.document;\n      var div = doc.createElement('div');\n      div.innerHTML = html;\n      if (!div.hasChildNodes() || div.childNodes.length > 1) {\n        domGlobals.console.error('HTML does not have a single root node', html);\n        throw new Error('HTML must have a single root node');\n      }\n      return fromDom(div.childNodes[0]);\n    };\n    var fromTag = function (tag, scope) {\n      var doc = scope || domGlobals.document;\n      var node = doc.createElement(tag);\n      return fromDom(node);\n    };\n    var fromText = function (text, scope) {\n      var doc = scope || domGlobals.document;\n      var node = doc.createTextNode(text);\n      return fromDom(node);\n    };\n    var fromDom = function (node) {\n      if (node === null || node === undefined) {\n        throw new Error('Node cannot be null or undefined');\n      }\n      return { dom: constant(node) };\n    };\n    var fromPoint = function (docElm, x, y) {\n      var doc = docElm.dom();\n      return Option.from(doc.elementFromPoint(x, y)).map(fromDom);\n    };\n    var Element = {\n      fromHtml: fromHtml,\n      fromTag: fromTag,\n      fromText: fromText,\n      fromDom: fromDom,\n      fromPoint: fromPoint\n    };\n\n    var ATTRIBUTE = domGlobals.Node.ATTRIBUTE_NODE;\n    var CDATA_SECTION = domGlobals.Node.CDATA_SECTION_NODE;\n    var COMMENT = domGlobals.Node.COMMENT_NODE;\n    var DOCUMENT = domGlobals.Node.DOCUMENT_NODE;\n    var DOCUMENT_TYPE = domGlobals.Node.DOCUMENT_TYPE_NODE;\n    var DOCUMENT_FRAGMENT = domGlobals.Node.DOCUMENT_FRAGMENT_NODE;\n    var ELEMENT = domGlobals.Node.ELEMENT_NODE;\n    var TEXT = domGlobals.Node.TEXT_NODE;\n    var PROCESSING_INSTRUCTION = domGlobals.Node.PROCESSING_INSTRUCTION_NODE;\n    var ENTITY_REFERENCE = domGlobals.Node.ENTITY_REFERENCE_NODE;\n    var ENTITY = domGlobals.Node.ENTITY_NODE;\n    var NOTATION = domGlobals.Node.NOTATION_NODE;\n\n    var ELEMENT$1 = ELEMENT;\n    var is = function (element, selector) {\n      var dom = element.dom();\n      if (dom.nodeType !== ELEMENT$1) {\n        return false;\n      } else {\n        var elem = dom;\n        if (elem.matches !== undefined) {\n          return elem.matches(selector);\n        } else if (elem.msMatchesSelector !== undefined) {\n          return elem.msMatchesSelector(selector);\n        } else if (elem.webkitMatchesSelector !== undefined) {\n          return elem.webkitMatchesSelector(selector);\n        } else if (elem.mozMatchesSelector !== undefined) {\n          return elem.mozMatchesSelector(selector);\n        } else {\n          throw new Error('Browser lacks native selectors');\n        }\n      }\n    };\n\n    var regularContains = function (e1, e2) {\n      var d1 = e1.dom();\n      var d2 = e2.dom();\n      return d1 === d2 ? false : d1.contains(d2);\n    };\n    var ieContains = function (e1, e2) {\n      return Node.documentPositionContainedBy(e1.dom(), e2.dom());\n    };\n    var browser = detect$3().browser;\n    var contains$1 = browser.isIE() ? ieContains : regularContains;\n\n    var Global = typeof domGlobals.window !== 'undefined' ? domGlobals.window : Function('return this;')();\n\n    var child = function (scope, predicate) {\n      var pred = function (node) {\n        return predicate(Element.fromDom(node));\n      };\n      var result = find(scope.dom().childNodes, pred);\n      return result.map(Element.fromDom);\n    };\n\n    var child$1 = function (scope, selector) {\n      return child(scope, function (e) {\n        return is(e, selector);\n      });\n    };\n\n    var count = 0;\n    var getFigureImg = function (elem) {\n      return child$1(Element.fromDom(elem), 'img');\n    };\n    var isFigure = function (editor, elem) {\n      return editor.dom.is(elem, 'figure');\n    };\n    var getEditableImage = function (editor, elem) {\n      var isImage = function (imgNode) {\n        return editor.dom.is(imgNode, 'img:not([data-mce-object],[data-mce-placeholder])');\n      };\n      var isEditable = function (imgNode) {\n        return isImage(imgNode) && (isLocalImage(editor, imgNode) || isCorsImage(editor, imgNode) || editor.settings.imagetools_proxy);\n      };\n      if (isFigure(editor, elem)) {\n        var imgOpt = getFigureImg(elem);\n        return imgOpt.map(function (img) {\n          return isEditable(img.dom()) ? Option.some(img.dom()) : Option.none();\n        });\n      }\n      return isEditable(elem) ? Option.some(elem) : Option.none();\n    };\n    var displayError = function (editor, error) {\n      editor.notificationManager.open({\n        text: error,\n        type: 'error'\n      });\n    };\n    var getSelectedImage = function (editor) {\n      var elem = editor.selection.getNode();\n      if (isFigure(editor, elem)) {\n        return getFigureImg(elem);\n      } else {\n        return Option.some(Element.fromDom(elem));\n      }\n    };\n    var extractFilename = function (editor, url) {\n      var m = url.match(/\\/([^\\/\\?]+)?\\.(?:jpeg|jpg|png|gif)(?:\\?|$)/i);\n      if (m) {\n        return editor.dom.encode(m[1]);\n      }\n      return null;\n    };\n    var createId = function () {\n      return 'imagetools' + count++;\n    };\n    var isLocalImage = function (editor, img) {\n      var url = img.src;\n      return url.indexOf('data:') === 0 || url.indexOf('blob:') === 0 || new global$4(url).host === editor.documentBaseURI.host;\n    };\n    var isCorsImage = function (editor, img) {\n      return global$1.inArray(getCorsHosts(editor), new global$4(img.src).host) !== -1;\n    };\n    var isCorsWithCredentialsImage = function (editor, img) {\n      return global$1.inArray(getCredentialsHosts(editor), new global$4(img.src).host) !== -1;\n    };\n    var defaultFetchImage = function (editor, img) {\n      var src = img.src, apiKey;\n      if (isCorsImage(editor, img)) {\n        return getUrl(img.src, null, isCorsWithCredentialsImage(editor, img));\n      }\n      if (!isLocalImage(editor, img)) {\n        src = getProxyUrl(editor);\n        src += (src.indexOf('?') === -1 ? '?' : '&') + 'url=' + encodeURIComponent(img.src);\n        apiKey = getApiKey(editor);\n        return getUrl(src, apiKey, false);\n      }\n      return imageToBlob$1(img);\n    };\n    var imageToBlob$2 = function (editor, img) {\n      return getFetchImage(editor).fold(function () {\n        return defaultFetchImage(editor, img);\n      }, function (customFetchImage) {\n        return customFetchImage(img);\n      });\n    };\n    var findBlob = function (editor, img) {\n      var blobInfo;\n      blobInfo = editor.editorUpload.blobCache.getByUri(img.src);\n      if (blobInfo) {\n        return global$3.resolve(blobInfo.blob());\n      }\n      return imageToBlob$2(editor, img);\n    };\n    var startTimedUpload = function (editor, imageUploadTimerState) {\n      var imageUploadTimer = global$2.setEditorTimeout(editor, function () {\n        editor.editorUpload.uploadImagesAuto();\n      }, getUploadTimeout(editor));\n      imageUploadTimerState.set(imageUploadTimer);\n    };\n    var cancelTimedUpload = function (imageUploadTimerState) {\n      global$2.clearTimeout(imageUploadTimerState.get());\n    };\n    var updateSelectedImage = function (editor, ir, uploadImmediately, imageUploadTimerState, selectedImage, size) {\n      return ir.toBlob().then(function (blob) {\n        var uri, name, blobCache, blobInfo;\n        blobCache = editor.editorUpload.blobCache;\n        uri = selectedImage.src;\n        if (shouldReuseFilename(editor)) {\n          blobInfo = blobCache.getByUri(uri);\n          if (blobInfo) {\n            uri = blobInfo.uri();\n            name = blobInfo.name();\n          } else {\n            name = extractFilename(editor, uri);\n          }\n        }\n        blobInfo = blobCache.create({\n          id: createId(),\n          blob: blob,\n          base64: ir.toBase64(),\n          uri: uri,\n          name: name\n        });\n        blobCache.add(blobInfo);\n        editor.undoManager.transact(function () {\n          function imageLoadedHandler() {\n            editor.$(selectedImage).off('load', imageLoadedHandler);\n            editor.nodeChanged();\n            if (uploadImmediately) {\n              editor.editorUpload.uploadImagesAuto();\n            } else {\n              cancelTimedUpload(imageUploadTimerState);\n              startTimedUpload(editor, imageUploadTimerState);\n            }\n          }\n          editor.$(selectedImage).on('load', imageLoadedHandler);\n          if (size) {\n            editor.$(selectedImage).attr({\n              width: size.w,\n              height: size.h\n            });\n          }\n          editor.$(selectedImage).attr({ src: blobInfo.blobUri() }).removeAttr('data-mce-src');\n        });\n        return blobInfo;\n      });\n    };\n    var selectedImageOperation = function (editor, imageUploadTimerState, fn, size) {\n      return function () {\n        var imgOpt = getSelectedImage(editor);\n        return imgOpt.fold(function () {\n          displayError(editor, 'Could not find selected image');\n        }, function (img) {\n          return editor._scanForImages().then(function () {\n            return findBlob(editor, img.dom());\n          }).then(blobToImageResult).then(fn).then(function (imageResult) {\n            return updateSelectedImage(editor, imageResult, false, imageUploadTimerState, img.dom(), size);\n          }, function (error) {\n            displayError(editor, error);\n          });\n        });\n      };\n    };\n    var rotate$2 = function (editor, imageUploadTimerState, angle) {\n      return function () {\n        var imgOpt = getSelectedImage(editor);\n        var flippedSize = imgOpt.fold(function () {\n          return null;\n        }, function (img) {\n          var size = ImageSize.getImageSize(img.dom());\n          return size ? {\n            w: size.h,\n            h: size.w\n          } : null;\n        });\n        return selectedImageOperation(editor, imageUploadTimerState, function (imageResult) {\n          return rotate$1(imageResult, angle);\n        }, flippedSize)();\n      };\n    };\n    var flip$2 = function (editor, imageUploadTimerState, axis) {\n      return function () {\n        return selectedImageOperation(editor, imageUploadTimerState, function (imageResult) {\n          return flip$1(imageResult, axis);\n        })();\n      };\n    };\n    var handleDialogBlob = function (editor, imageUploadTimerState, img, originalSize, blob) {\n      return new global$3(function (resolve) {\n        blobToImage$1(blob).then(function (newImage) {\n          var newSize = ImageSize.getNaturalImageSize(newImage);\n          if (originalSize.w !== newSize.w || originalSize.h !== newSize.h) {\n            if (ImageSize.getImageSize(img)) {\n              ImageSize.setImageSize(img, newSize);\n            }\n          }\n          domGlobals.URL.revokeObjectURL(newImage.src);\n          return blob;\n        }).then(blobToImageResult).then(function (imageResult) {\n          return updateSelectedImage(editor, imageResult, true, imageUploadTimerState, img);\n        }, function () {\n        });\n      });\n    };\n    var Actions = {\n      rotate: rotate$2,\n      flip: flip$2,\n      getEditableImage: getEditableImage,\n      cancelTimedUpload: cancelTimedUpload,\n      findBlob: findBlob,\n      getSelectedImage: getSelectedImage,\n      handleDialogBlob: handleDialogBlob\n    };\n\n    var saveState = constant('save-state');\n    var disable = constant('disable');\n    var enable = constant('enable');\n\n    var createState = function (blob) {\n      return {\n        blob: blob,\n        url: domGlobals.URL.createObjectURL(blob)\n      };\n    };\n    var makeOpen = function (editor, imageUploadTimerState) {\n      return function () {\n        var getLoadedSpec = function (currentState) {\n          return {\n            title: 'Edit Image',\n            size: 'large',\n            body: {\n              type: 'panel',\n              items: [{\n                  type: 'imagetools',\n                  name: 'imagetools',\n                  label: 'Edit Image',\n                  currentState: currentState\n                }]\n            },\n            buttons: [\n              {\n                type: 'cancel',\n                name: 'cancel',\n                text: 'Cancel'\n              },\n              {\n                type: 'submit',\n                name: 'save',\n                text: 'Save',\n                primary: true,\n                disabled: true\n              }\n            ],\n            onSubmit: function (api) {\n              var blob = api.getData().imagetools.blob;\n              originalImgOpt.each(function (originalImg) {\n                originalSizeOpt.each(function (originalSize) {\n                  Actions.handleDialogBlob(editor, imageUploadTimerState, originalImg.dom(), originalSize, blob);\n                });\n              });\n              api.close();\n            },\n            onCancel: function () {\n            },\n            onAction: function (api, details) {\n              switch (details.name) {\n              case saveState():\n                if (details.value) {\n                  api.enable('save');\n                } else {\n                  api.disable('save');\n                }\n                break;\n              case disable():\n                api.disable('save');\n                api.disable('cancel');\n                break;\n              case enable():\n                api.enable('cancel');\n                break;\n              }\n            }\n          };\n        };\n        var originalImgOpt = Actions.getSelectedImage(editor);\n        var originalSizeOpt = originalImgOpt.map(function (origImg) {\n          return ImageSize.getNaturalImageSize(origImg.dom());\n        });\n        var imgOpt = Actions.getSelectedImage(editor);\n        imgOpt.each(function (img) {\n          Actions.getEditableImage(editor, img.dom()).each(function (_) {\n            Actions.findBlob(editor, img.dom()).then(function (blob) {\n              var state = createState(blob);\n              editor.windowManager.open(getLoadedSpec(state));\n            });\n          });\n        });\n      };\n    };\n    var Dialog = { makeOpen: makeOpen };\n\n    var register = function (editor, imageUploadTimerState) {\n      global$1.each({\n        mceImageRotateLeft: Actions.rotate(editor, imageUploadTimerState, -90),\n        mceImageRotateRight: Actions.rotate(editor, imageUploadTimerState, 90),\n        mceImageFlipVertical: Actions.flip(editor, imageUploadTimerState, 'v'),\n        mceImageFlipHorizontal: Actions.flip(editor, imageUploadTimerState, 'h'),\n        mceEditImage: Dialog.makeOpen(editor, imageUploadTimerState)\n      }, function (fn, cmd) {\n        editor.addCommand(cmd, fn);\n      });\n    };\n    var Commands = { register: register };\n\n    var setup = function (editor, imageUploadTimerState, lastSelectedImageState) {\n      editor.on('NodeChange', function (e) {\n        var lastSelectedImage = lastSelectedImageState.get();\n        if (lastSelectedImage && lastSelectedImage.src !== e.element.src) {\n          Actions.cancelTimedUpload(imageUploadTimerState);\n          editor.editorUpload.uploadImagesAuto();\n          lastSelectedImageState.set(null);\n        }\n        Actions.getEditableImage(editor, e.element).each(lastSelectedImageState.set);\n      });\n    };\n    var UploadSelectedImage = { setup: setup };\n\n    var register$1 = function (editor) {\n      var cmd = function (command) {\n        return function () {\n          return editor.execCommand(command);\n        };\n      };\n      editor.ui.registry.addButton('rotateleft', {\n        tooltip: 'Rotate counterclockwise',\n        icon: 'rotate-left',\n        onAction: cmd('mceImageRotateLeft')\n      });\n      editor.ui.registry.addButton('rotateright', {\n        tooltip: 'Rotate clockwise',\n        icon: 'rotate-right',\n        onAction: cmd('mceImageRotateRight')\n      });\n      editor.ui.registry.addButton('flipv', {\n        tooltip: 'Flip vertically',\n        icon: 'flip-vertically',\n        onAction: cmd('mceImageFlipVertical')\n      });\n      editor.ui.registry.addButton('fliph', {\n        tooltip: 'Flip horizontally',\n        icon: 'flip-horizontally',\n        onAction: cmd('mceImageFlipHorizontal')\n      });\n      editor.ui.registry.addButton('editimage', {\n        tooltip: 'Edit image',\n        icon: 'edit-image',\n        onAction: cmd('mceEditImage'),\n        onSetup: function (buttonApi) {\n          var setDisabled = function () {\n            var elementOpt = Actions.getSelectedImage(editor);\n            elementOpt.each(function (element) {\n              var disabled = Actions.getEditableImage(editor, element.dom()).isNone();\n              buttonApi.setDisabled(disabled);\n            });\n          };\n          editor.on('NodeChange', setDisabled);\n          return function () {\n            editor.off('NodeChange', setDisabled);\n          };\n        }\n      });\n      editor.ui.registry.addButton('imageoptions', {\n        tooltip: 'Image options',\n        icon: 'image-options',\n        onAction: cmd('mceImage')\n      });\n      editor.ui.registry.addContextMenu('imagetools', {\n        update: function (element) {\n          return Actions.getEditableImage(editor, element).fold(function () {\n            return [];\n          }, function (_) {\n            return [{\n                text: 'Edit image',\n                icon: 'edit-image',\n                onAction: cmd('mceEditImage')\n              }];\n          });\n        }\n      });\n    };\n    var Buttons = { register: register$1 };\n\n    var register$2 = function (editor) {\n      editor.ui.registry.addContextToolbar('imagetools', {\n        items: getToolbarItems(editor),\n        predicate: function (elem) {\n          return Actions.getEditableImage(editor, elem).isSome();\n        },\n        position: 'node',\n        scope: 'node'\n      });\n    };\n    var ContextToolbar = { register: register$2 };\n\n    function Plugin () {\n      global.add('imagetools', function (editor) {\n        var imageUploadTimerState = Cell(0);\n        var lastSelectedImageState = Cell(null);\n        Commands.register(editor, imageUploadTimerState);\n        Buttons.register(editor);\n        ContextToolbar.register(editor);\n        UploadSelectedImage.setup(editor, imageUploadTimerState, lastSelectedImageState);\n      });\n    }\n\n    Plugin();\n\n}(window));\n"]}